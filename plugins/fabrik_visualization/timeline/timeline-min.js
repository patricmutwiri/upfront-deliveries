/*! Fabrik */

var FbVisTimeline=new Class({Implements:[Options],options:{dateFormat:"%c",orientation:"0",urlfilters:[]},initialize:function(json,options){this.json=eval(json),this.setOptions(options),this.resizeTimerID=null,this.tl=null;var dateFormat=this.options.dateFormat;Timeline.GregorianDateLabeller.prototype.labelPrecise=function(a){return new Date(a.getTime()+6e4*a.getTimezoneOffset()).format(dateFormat)},this.eventSource=new Timeline.DefaultEventSource;var theme=Timeline.ClassicTheme.create();theme.event.bubble.width=320,theme.event.bubble.height=520,theme.event.track.height=11.5,theme.event.track.gap=.1,theme.ether.backgroundColors=["#000000","red"],theme.ether.highlightColor="red",Timeline.setDefaultTheme(theme);for(var bandBase={trackGap:.2,width:"70%",intervalUnit:Timeline.DateTime.DAY,intervalPixels:50},bandTracks=[],b=0;b<json.bands.length;b++){var bandClone=Object.clone(bandBase);bandClone.width=json.bands[b].width,bandClone.intervalUnit=json.bands[b].intervalUnit,bandClone.overview=json.bands[b].overview,bandClone.eventSource=this.eventSource,bandClone.theme=theme,bandTracks.push(Timeline.createBandInfo(bandClone))}for(b=1;b<json.bands.length;b++)bandTracks[b].syncWith=0,bandTracks[b].highlight=!0;SimileAjax.History.enabled=!1,this.tl=Timeline.create(document.id("my-timeline"),bandTracks,this.options.orientation),this.start=0;var data={option:"com_fabrik",format:"raw",task:"ajax_getEvents",view:"visualization",visualizationid:this.options.id,currentList:this.options.currentList,setListRefFromRequest:1,listref:this.options.listRef};data=Object.merge(data,this.options.urlfilters),this.options.admin?data.task="visualization.ajax_getEvents":data.controller="visualization.timeline",this.start=0,this.counter=new Element("div.timelineTotals").inject(document.id("my-timeline"),"before"),this.counter.set("text","loading"),this.ajax=new Request.JSON({url:"index.php",data:data,onSuccess:function(a){this.start=this.start+this.options.step,this.start>=a.fabrik.total?this.counter.set("text","loaded "+a.fabrik.total):this.counter.set("text","loading "+this.start+" / "+a.fabrik.total),this.eventSource.loadJSON(a.timeline.events,""),0===a.fabrik.done.toInt()&&(this.ajax.options.data.start=a.fabrik.next,this.ajax.options.data.currentList=a.fabrik.currentList,this.ajax.send())}.bind(this),onFailure:function(a){alert(a.status+": "+a.statusText)}}),Fabrik.addEvent("fabrik.advancedSearch.submit",function(a){console.log("cancel ajax"),this.ajax.cancel()}.bind(this)),this.ajax.send(),window.addEvent("resize",function(){null===this.resizeTimerID&&(this.resizeTimerID=window.setTimeout(function(){this.resizeTimerID=null,this.tl.layout()}.bind(this),500))}.bind(this)),this.watchDatePicker()},watchDatePicker:function(){var a=document.id("timelineDatePicker");if("null"!==typeOf(a)){var b={eventName:"click",ifFormat:this.options.dateFormat,daFormat:this.options.dateFormat,singleClick:!0,align:"Br",range:[1900,2999],showsTime:!1,timeFormat:"24",electric:!0,step:2,cache:!1,showOthers:!1,advanced:!1},c=this.options.dateFormat;b.date=Date.parseDate(a.value||a.innerHTML,c),b.onClose=function(a){a.hide()},b.onSelect=function(){(this.cal.dateClicked||this.cal.hiliteToday)&&(this.cal.callCloseHandler(),a.value=this.cal.date.format(c),this.tl.getBand(0).setCenterVisibleDate(this.cal.date))}.bind(this),b.inputField=a,b.button=document.id("timelineDatePicker_cal_img"),b.align="Tl",b.singleClick=!0,this.cal=new Calendar(0,b.date,b.onSelect,b.onClose),this.cal.showsOtherMonths=b.showOthers,this.cal.yearStep=b.step,this.cal.setRange(b.range[0],b.range[1]),this.cal.params=b,this.cal.setDateFormat(c),this.cal.create(),this.cal.refresh(),this.cal.hide(),"null"!==typeOf(b.button)&&b.button.addEvent("click",function(a){this.cal.showAtElement(b.button),this.cal.show()}.bind(this)),a.addEvent("blur",function(a){this.updateFromField()}.bind(this)),a.addEvent("keyup",function(a){"enter"===a.key&&this.updateFromField()}.bind(this))}},updateFromField:function(){var a=document.id("timelineDatePicker").value;d=Date.parseDate(a,this.options.dateFormat),this.cal.date=d;var b=new Date(this.cal.date.getTime()-6e4*this.cal.date.getTimezoneOffset());this.tl.getBand(0).scrollToCenter(b)},submit:function(){}});