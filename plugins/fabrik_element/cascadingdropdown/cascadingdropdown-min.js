/*! Fabrik */

define(["jquery","element/databasejoin/databasejoin","fab/autocomplete-bootstrap-cdd"],function(a,b,c){return window.FbCascadingdropdown=new Class({options:{watchInSameGroup:!0},Extends:b,initialize:function(a,b){this.ignoreAjax=!1,this.setPlugin("cascadingdropdown"),this.parent(a,b),document.id(this.options.watch)&&(this.doChangeEvent=this.doChange.bind(this),document.id(this.options.watch).addEvent(this.options.watchChangeEvent,this.doChangeEvent)),!0===this.options.showDesc&&this.element.addEvent("change",function(a){this.showDesc(a)}.bind(this)),"null"!==typeOf(this.element)&&(this.spinner=new Spinner(this.element.getParent(".fabrikElementContainer")))},attachedToForm:function(){if(this.ignoreAjax||this.options.editable&&!this.options.editing){this.ignoreAjax=!1;var a=this.form.formElements.get(this.options.watch).getValue();this.change(a,document.id(this.options.watch).id)}this.parent()},dowatch:function(a){var b=Fabrik.blocks[this.form.form.id].formElements[this.options.watch].getValue();this.change(b,a.target.id)},doChange:function(a){"auto-complete"===this.options.displayType&&(this.element.value="",this.getAutoCompleteLabelField().value=""),this.dowatch(a)},change:function(a,b){var c,d,e,f,g;window.ie&&0===this.options.repeatCounter.toInt()&&(d=b.substr(b.length-2,1),e=b.substr(b.length-1,1),"_"===d&&"number"===typeOf(parseInt(e,10))&&"0"!==e)||(this.spinner.show(),f=this.form.getFormElementData(),g={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"cascadingdropdown",method:"ajax_getOptions",element_id:this.options.id,v:a,formid:this.form.id,fabrik_cascade_ajax_update:1,lang:this.options.lang},g=Object.append(f,g),this.myAjax&&this.myAjax.cancel(),this.myAjax=new Request({url:"",method:"post",data:g,onComplete:function(){this.spinner.hide()}.bind(this),onSuccess:function(a){var b,d,e=this.getValue();this.spinner.hide(),a=JSON.parse(a),this.options.editable?this.destroyElement():this.element.getElements("div").destroy(),!0===this.options.showDesc&&(d=this.getContainer().getElement(".dbjoin-description"),d.empty()),this.myAjax=null;var f=1===a.length;if(this.ignoreAjax){if(this.options.showPleaseSelect&&a.length>0){var g=a.shift();!1===this.options.editable?new Element("div").set("text",g.text).inject(this.element):(b=""!==g.value&&g.value===e||f,this.addOption(g.value,g.text,b),new Element("option",{value:g.value,selected:"selected"}).set("text",g.text).inject(this.element))}}else a.each(function(a){if(!1===this.options.editable?(a.text=a.text.replace(/\n/g,"<br />"),new Element("div").set("html",a.text).inject(this.element)):(b=""!==a.value&&a.value===e||f,this.addOption(a.value,a.text,b)),!0===this.options.showDesc&&a.description){var g=this.options.showPleaseSelect?"notice description-"+c:"notice description-NaN";new Element("div",{styles:{display:"none"},class:g}).set("html",a.description).inject(d)}}.bind(this));this.ignoreAjax=!1,this.options.editable&&"dropdown"===this.options.displayType&&(1===this.element.options.length?this.element.addClass("readonly"):this.element.removeClass("readonly")),this.renewEvents(),this.ignoreAjax||(this.ingoreShowDesc=!0,this.element.fireEvent("change",new Event.Mock(this.element,"change")),this.ingoreShowDesc=!1),this.ignoreAjax=!1;var h=[this.getValue()];this.setValue(h),Fabrik.fireEvent("fabrik.cdd.update",this)}.bind(this),onFailure:function(a){console.log(this.myAjax.getHeader("Status"))}.bind(this)}).send())},destroyElement:function(){switch(this.options.displayType){case"radio":case"checkbox":this.getContainer().getElements('*[data-role="suboption"]').destroy(),this.getContainer().getElements('*[data-role="fabrik-rowopts"]').destroy();break;case"dropdown":default:this.element.empty()}},cloned:function(a){this.myAjax=null,this.parent(a),this.spinner=new Spinner(this.element.getParent(".fabrikElementContainer")),document.id(this.options.watch)&&(!0===this.options.watchInSameGroup&&(this.options.watch.test(/_(\d+)$/)?this.options.watch=this.options.watch.replace(/_(\d+)$/,"_"+a):this.options.watch=this.options.watch+"_"+a),document.id(this.options.watch)&&(this.options.watchInSameGroup&&document.id(this.options.watch).removeEvent(this.options.watchChangeEvent,this.doChangeEvent),this.doChangeEvent=this.doChange.bind(this),document.id(this.options.watch).addEvent(this.options.watchChangeEvent,this.doChangeEvent))),!0===this.options.watchInSameGroup&&(this.element.empty(),this.ignoreAjax=!0),!0===this.options.showDesc&&this.element.addEvent("change",function(){this.showDesc()}.bind(this)),Fabrik.fireEvent("fabrik.cdd.update",this)},cloneAutoComplete:function(){var a=this.getAutoCompleteLabelField();a.id=this.element.id+"-auto-complete",a.name=this.element.name.replace("[]","")+"-auto-complete",document.id(a.id).value="",new c(this.element.id,this.options.autoCompleteOpts)},showDesc:function(a){if(!0!==this.ingoreShowDesc){var b,c=document.id(a.target).selectedIndex,d=this.getContainer().getElement(".dbjoin-description"),e=d.getElement(".description-"+c);d.getElements(".notice").each(function(a){a===e?(b=new Fx.Style(e,"opacity",{duration:400,transition:Fx.Transitions.linear}),b.set(0),a.show(),b.start(0,1)):a.hide()}.bind(this))}}}),window.FbCascadingdropdown});