/*! Fabrik */

define(["jquery","fab/list-plugin"],function(a,b){var c=new Class({initialize:function(){this.updates={}},addFilter:function(a,b){this.updates[a]||(this.updates[a]=[]),this.updates[a].push(b)},onSumbit:function(){this.updates.date&&this.updates.date.each(function(a){a.onSubmit()})}});return new Class({Extends:b,initialize:function(a){if(this.parent(a),this.options.userSelect){var b="filter_update_col"+this.options.ref+"_"+this.options.renderOrder;Fabrik[b]=new c,this.makeUpdateColWindow()}},buttonAction:function(){this.options.userSelect?this.win.open():this.list.submit("list.doPlugin")},makeUpdateColWindow:function(){var a,b,c,d=this;d.windowopts={id:"update_col_win_"+d.options.ref+"_"+d.options.renderOrder,title:Joomla.JText._("PLG_LIST_UPDATE_COL_UPDATE"),loadMethod:"html",content:d.options.form,width:400,destroy:!1,height:300,onOpen:function(){this.fitToContent(!1)},onContentLoaded:function(e){var f=document.id("update_col"+d.options.ref+"_"+d.options.renderOrder);f.addEvent("click:relay(a.add)",function(c,d){c.preventDefault();var e;e=d.getParent("thead")?f.getElements("tbody tr").getLast():d.getParent("tr"),"none"===e.getStyle("display")?(a=e.getElements("td"),a[0].getElement("select").selectedIndex=0,a[1].empty(),e.show()):(b=e.clone(),a=b.getElements("td"),a[0].getElement("select").selectedIndex=0,a[1].empty(),b.inject(e,"after"))}),f.addEvent("click:relay(a.delete)",function(a,b){a.preventDefault();var c=f.getElements("tbody tr");1===c.length?c.getLast().hide():b.getParent("tr").destroy()}),f.addEvent("change:relay(select.key)",function(a,b){var e=b.getParent("tbody").getElements(".update_col_elements");for(c=0;c<e.length;c++)if(e[c]!==b&&e[c].selectedIndex===b.selectedIndex)return void window.alert("This element has already been selected!");var f=b.options[b.selectedIndex],g=b.getParent("tr");Fabrik.loader.start(g);var h=g.getElement("td.update_col_value"),i=b.get("value"),j=f.get("data-plugin"),k=f.get("data-id");new Request.HTML({url:"index.php?option=com_fabrik&task=list.elementFilter&format=raw",update:h,data:{element:i,id:d.options.listid,elid:k,plugin:j,counter:0,listref:d.options.ref,context:"visualization",parentView:"update_col"+d.options.ref+"_"+d.options.renderOrder,fabrikIngoreDefaultFilterVal:1},onComplete:function(){Fabrik.loader.stop(g),d.win.fitToContent(!1)}}).send()}),f.getElement("input[type=button]").addEvent("click",function(a){a.stop();var b;Fabrik["filter_update_col"+d.options.ref+"_"+d.options.renderOrder].onSumbit();var c=document.id("listform_"+d.options.ref);b=new Element("input",{type:"hidden",value:f.toQueryString(),name:"fabrik_update_col"}),b.inject(c,"bottom"),d.list.submit("list.doPlugin")})}},d.win=Fabrik.getWindow(d.windowopts),d.win.close()}})});